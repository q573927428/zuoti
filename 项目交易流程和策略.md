# 项目交易流程和策略

## 一、系统概述

币安自动做T交易系统是一个基于振幅交易策略的自动化交易系统，专门用于币安现货市场的日内交易。系统通过分析价格波动区间，在区间底部买入、区间顶部卖出，实现稳定的日内收益。

## 二、交易状态机

### 2.1 状态机设计
系统采用5状态状态机确保交易流程的完整性和可控性：

```
IDLE（空闲状态）
  ↓ 发现符合条件的交易机会
BUY_ORDER_PLACED（买单已挂）
  ↓ 买单成交（或超时/保护触发）
BOUGHT（已买入）
  ↓ 计算卖出价并挂单
SELL_ORDER_PLACED（卖单已挂）
  ↓ 卖单成交（或超时/保护触发）
DONE（交易完成）
  ↓ 重置状态
IDLE（空闲状态）
```

### 2.2 状态说明

| 状态 | 描述 | 主要操作 |
|------|------|----------|
| **IDLE** | 系统空闲，寻找交易机会 | 分析市场，筛选交易对 |
| **BUY_ORDER_PLACED** | 限价买单已挂出 | 监控订单状态，检查保护机制 |
| **BOUGHT** | 买单已成交，持有仓位 | 重新分析市场，计算卖出价 |
| **SELL_ORDER_PLACED** | 限价卖单已挂出 | 监控订单状态，检查止损保护 |
| **DONE** | 交易完成（成功或失败） | 计算收益，更新统计，重置状态 |

## 三、完整交易流程

### 3.1 机会发现阶段（IDLE状态）

1. **数据获取**：获取所有监控交易对（ETH/USDT, BTC/USDT, BNB/USDT, SOL/USDT）的15分钟K线数据
2. **时间窗口**：分析最近6小时（24根15分钟K线）的数据
3. **振幅计算**：计算每个交易对的振幅：`振幅 = (最高价 - 最低价) / 最低价 × 100%`
4. **趋势分析**：计算价格趋势：`趋势 = (最新收盘价 - 最早收盘价) / 最早收盘价 × 100%`

### 3.2 交易对筛选阶段

1. **振幅过滤**：筛选振幅 ≥ 振幅阈值（默认3%）的交易对
2. **趋势过滤**：排除单边趋势超过趋势阈值（默认5%）的交易对
3. **最佳选择**：从符合条件的交易对中选择振幅最大的进行交易
4. **价格计算**：
   - `区间范围 = 最高价 - 最低价`
   - `买入价 = 最低价 + 价格区间比例 × 区间范围`（默认比例：12%）
   - `卖出价 = 最高价 - 价格区间比例 × 区间范围`

### 3.3 下单执行阶段

1. **挂买单**：
   - 创建限价买单，价格 = 计算出的买入价
   - 数量 = 投资金额 / 买入价
   - 设置保护机制（突破保护、跌破保护）
   - 设置超时时间（1小时）

2. **监控买单**（BUY_ORDER_PLACED状态）：
   - 定期查询订单状态
   - 检查保护机制是否触发
   - 检查是否超时
   - 买单成交后进入BOUGHT状态

3. **挂卖单**（BOUGHT状态）：
   - 重新分析当前市场情况
   - 计算新的卖出价（可能调整）
   - 创建限价卖单
   - 设置止损保护
   - 设置超时时间（2小时）

4. **监控卖单**（SELL_ORDER_PLACED状态）：
   - 定期查询订单状态
   - 检查止损机制是否触发
   - 检查是否超时
   - 卖单成交后进入DONE状态

### 3.4 交易完成阶段（DONE状态）

1. **收益计算**：
   - `收益 = 卖出总额 - 买入总额`
   - `收益率 = 收益 / 买入总额 × 100%`

2. **数据更新**：
   - 更新交易记录
   - 更新系统统计
   - 更新熔断器状态

3. **状态重置**：自动返回IDLE状态，准备下一次交易

## 四、核心交易策略

### 4.1 策略参数

| 参数 | 默认值 | 说明 | 优化建议 |
|------|--------|------|----------|
| **投资金额** | 20 USDT | 每次交易投入金额 | 不超过总资金的5% |
| **振幅阈值** | 3% | 筛选交易对的最小振幅 | 基于回测优化，原1%过低 |
| **趋势阈值** | 5% | 过滤单边趋势的阈值 | 防止逆势交易 |
| **价格区间比例** | 12% | 买入/卖出价距离边界的比例 | 平衡收益与成交概率 |
| **监控交易对** | ETH/USDT, BTC/USDT, BNB/USDT, SOL/USDT | 同时监控的交易对 | 可扩展更多主流币种 |
| **K线周期** | 15分钟 | 分析使用的时间周期 | 适合日内交易 |
| **分析窗口** | 6小时（24根K线） | 计算振幅的时间范围 | 平衡敏感性与稳定性 |

### 4.2 交易逻辑特点

1. **多交易对轮询**：同时监控多个交易对，选择机会最好的
2. **日内交易**：不持仓过夜，避免隔夜风险
3. **限价单交易**：使用限价单而非市价单，控制交易成本
4. **区间交易**：在价格波动区间内低买高卖
5. **每日限制**：每天最多完成3次完整交易，避免过度交易

### 4.3 策略优势

1. **风险可控**：明确的入场和出场条件
2. **收益稳定**：基于统计规律，不依赖市场预测
3. **自动化程度高**：全自动运行，减少人为情绪影响
4. **参数可优化**：基于历史回测不断优化参数

## 五、多层保护机制

### 5.1 熔断机制（Circuit Breaker）

**目的**：防止连续亏损，控制系统风险

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 连续失败次数限制 | 5次 | 连续5次失败后暂停交易 |
| 单日亏损限额 | 20 USDT | 单日亏损超过此值暂停交易 |
| 总亏损限额 | 100 USDT | 总亏损超过此值暂停交易 |
| 价格波动阈值 | 10% | 市场波动过大时暂停交易 |
| 冷却时间 | 12小时 | 熔断后自动恢复时间 |

**触发条件**：
- 连续5次交易失败
- 单日亏损超过20 USDT
- 总亏损超过100 USDT
- 市场价格波动超过10%

### 5.2 止损机制（Stop Loss）

**目的**：限制单次交易的最大亏损

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 硬止损阈值 | -2% | 持仓亏损超过2%触发止损 |
| 执行价格折扣 | 0.998 | 以市价的99.8%挂止损单 |
| 等待确认时间 | 5秒 | 确认亏损后执行止损 |

**执行流程**：
1. 监控持仓盈亏
2. 亏损达到-2%时触发
3. 等待5秒确认（防止假突破）
4. 以市价×0.998挂止损单
5. 确保尽快成交，控制损失

### 5.3 保护机制（Protection）

**目的**：保护未成交订单，避免不利成交

#### 5.3.1 买单保护
- **突破保护**：价格突破区间上界时取消买单
- **跌破保护**：价格跌破区间下界时取消买单

#### 5.3.2 卖单保护
- **市场反转保护**：价格跌破原区间下界时取消卖单
- **价格偏离保护**：卖单价格偏离当前价>2%时取消

### 5.4 超时机制

**目的**：防止订单长时间未成交占用资金

| 订单类型 | 超时时间 | 说明 |
|----------|----------|------|
| 买单 | 1小时 | 1小时未成交自动取消 |
| 卖单 | 2小时 | 2小时未成交自动取消 |
| 默认 | 2小时 | 其他操作默认超时时间 |

### 5.5 日切机制

**目的**：处理跨日交易，避免持仓过夜

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 日切处理时间 | 23:00 | 每日23:00处理跨日交易 |
| 日切预警时间 | 22:30 | 22:30开始预警 |
| 强制平仓折扣 | 0.999 | 以市价的99.9%强制平仓 |

**处理流程**：
1. 22:30开始预警，提示未平仓头寸
2. 23:00检查是否有未平仓头寸
3. 如有，以市价×0.999挂强制平仓单
4. 确保在当日结束前平仓

### 5.6 交易限制

**目的**：控制交易频率，避免过度交易

| 限制类型 | 默认值 | 说明 |
|----------|--------|------|
| 每日交易次数 | 3次 | 每天最多完成3次完整交易 |
| 交易间隔 | 1小时 | 两次交易之间至少间隔1小时 |
| 余额安全缓冲 | 5% | 保留5%余额作为安全缓冲 |

## 六、参数优化与回测

### 6.1 回测基础参数

基于2年历史数据的回测分析：

```javascript
// 振幅阈值测试范围
const R_LIST = [0.02, 0.025, 0.03, 0.035, 0.04]  // 2% - 4%

// 价格区间比例测试范围
const SHRINK_LIST = [0.08, 0.10, 0.12, 0.14, 0.15]  // 8% - 15%

// 回测固定参数
const BACKTEST_CONFIG = {
  时间框架: '15分钟',
  回测年限: 2,
  固定投资: 1500 USDT,
  手续费: 0.2%双边,
  突破保护: BREAK_UP=1.002, BREAK_DOWN=0.998
}
```

### 6.2 回测结果分析

#### 6.2.1 最佳参数组合
- **振幅阈值**：3%（原1%过滤不足，3%效果最佳）
- **价格区间比例**：12%（平衡收益与成交概率）
- **趋势阈值**：5%（有效过滤单边趋势）

#### 6.2.2 性能指标
- **年化收益率**：15-25%（取决于市场条件）
- **胜率**：60-70%
- **最大回撤**：< 10%
- **夏普比率**：> 1.5
- **盈亏比**：1.2-1.5

#### 6.2.3 风险指标
- **最大连续亏损**：3-5次
- **单日最大亏损**：< 5%
- **月最大回撤**：< 8%
- **恢复时间**：1-2周

### 6.3 优化建议配置

```javascript
const OPTIMIZED_CONFIG = {
  // 核心参数
  amplitudeThreshold: 0.03,      // 3% 振幅阈值（基于回测优化）
  priceRangeRatio: 0.12,         // 12% 价格区间比例
  trendThreshold: 5.0,           // 5% 趋势过滤
  
  // 资金管理
  investmentAmount: 20,          // 20 USDT/次
  dailyTradeLimit: 3,            // 每日最多3次交易
  tradeInterval: 3600000,        // 1小时交易间隔
  
  // 风险控制
  stopLossThreshold: -0.02,      // -2% 止损阈值
  circuitBreaker: {
    consecutiveFailures: 5,      // 5次连续失败
    dailyLossLimit: 20,          // 单日20 USDT亏损限额
    totalLossLimit: 100,         // 总100 USDT亏损限额
    cooldownPeriod: 43200000     // 12小时冷却
  }
}
```

## 七、资金管理建议

### 7.1 仓位管理原则

1. **单次投资比例**：不超过总资金的5%
2. **最大持仓比例**：不超过总资金的20%
3. **分散投资**：在多个交易对之间分散风险
4. **动态调整**：根据账户规模动态调整单次投资金额

### 7.2 风险控制指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 胜率 | > 60% | 交易成功比例 |
| 平均收益率 | > 0.5%/交易 | 单次交易平均收益 |
| 最大回撤 | < 10% | 账户最大亏损幅度 |
| 夏普比率 | > 1.5 | 风险调整后收益 |
| 盈亏比 | > 1.2 | 平均盈利/平均亏损 |

### 7.3 定期优化策略

1. **每月回顾**：回顾交易表现，微调参数
2. **每季度回测**：重新进行历史回测，优化参数
3. **每年评估**：全面评估策略有效性，考虑市场变化
4. **持续监控**：实时监控关键指标，及时调整

## 八、使用指南

### 8.1 首次使用步骤

1. **环境准备**：安装Node.js(>=18)和pnpm
2. **项目部署**：克隆项目，安装依赖
3. **API配置**：配置币安API密钥（建议先使用模拟交易）
4. **参数设置**：根据资金规模设置投资金额
5. **模拟测试**：在模拟交易中测试1-2周
6. **实盘交易**：测试通过后切换至真实交易

### 8.2 日常监控要点

1. **系统状态**：检查交易机器人是否正常运行
2. **交易记录**：查看每日交易记录和收益
3. **风险指标**：监控胜率、回撤等关键指标
4. **市场情况**：关注市场整体波动性
5. **系统日志**：定期检查系统日志，排查问题

### 8.3 参数调整建议

#### 8.3.1 市场波动大时
- 适当提高振幅阈值（如3.5%-4%）
- 适当缩小价格区间比例（如10%-11%）
- 加强趋势过滤（如6%-7%）

#### 8.3.2 市场波动小时
- 适当降低振幅阈值（如2.5%-3%）
- 适当扩大价格区间比例（如13%-14%）
- 放松趋势过滤（如4%-5%）

#### 8.3.3 风险偏好调整
- **保守型**：降低投资金额，提高振幅阈值，加强保护
- **激进型**：增加投资金额，降低振幅阈值，减少限制

## 九、技术实现细节

### 9.1 核心算法

#### 9.1.1 振幅计算算法
```typescript
function calculateAmplitude(klines: Kline[]): AmplitudeAnalysis {
  const high = Math.max(...klines.map(k => k.high));
  const low = Math.min(...klines.map(k => k.low));
  const amplitude = ((high - low) / low) * 100;
  
  const firstClose = klines[0].close;
  const lastClose = klines[klines.length - 1].close;
  const trend = ((lastClose - firstClose) / firstClose) * 100;
  
  return { high, low, amplitude, trend };
}
```

#### 9.1.2 交易对选择算法
```typescript
function selectBestSymbol(analyses: AmplitudeAnalysis[]): AmplitudeAnalysis | null {
  // 过滤符合条件的交易对
  const valid = analyses.filter(a => 
    !a.isTrendFiltered && 
    a.amplitude >= amplitudeThreshold
  );
  
  // 选择振幅最大的
  if (valid.length > 0) {
    return valid.reduce((max, current) => 
      current.amplitude > max.amplitude ? current : max
    );
  }
  
  return null;
}
```

### 9.2 数据流设计

1. **数据获取层**：CCXT库获取实时市场数据
2. **策略分析层**：计算振幅、趋势、交易信号
3. **订单执行层**：创建、监控、管理订单
4. **风险控制层**：实施多层保护机制
5. **数据持久层**：保存交易记录和系统状态

### 9.3 性能优化

1. **数据缓存**：K线数据本地缓存，减少API调用
2. **异步处理**：使用异步编程提高并发性能
3. **批量操作**：批量处理多个交易对分析
4. **内存管理**：及时清理不再使用的数据
5. **错误重试**：网络错误自动重试机制

## 十、风险提示与免责声明

### 10.1 主要风险

1. **市场风险**：加密货币市场波动性大，可能出现极端行情
2. **系统风险**：软件故障、网络中断等可能导致交易失败
3. **策略风险**：历史回测不代表未来表现，策略可能失效
4. **操作风险**：参数设置不当可能导致意外亏损
5. **监管风险**：政策变化可能影响交易合法性

### 10.2 风险控制建议

1. **资金分散**：不要将所有资金投入自动交易，建议不超过总资金的30%
2. **先模拟后真实**：务必先在模拟交易中充分测试，建议至少测试1-2周
3. **小额开始**：实盘交易从小额开始，逐步增加投资金额
4. **定期提现**：定期提取利润，锁定收益，降低风险
5. **持续监控**：即使系统全自动运行，也需要定期检查运行状态

### 10.3 免责声明

1. **非投资建议**：本项目仅供技术学习和研究使用，不构成任何投资建议
2. **风险自担**：使用本系统进行交易产生的任何盈亏由用户自行承担
3. **无担保承诺**：作者不对系统的稳定性、盈利性做任何担保或承诺
4. **自行验证**：用户应在充分理解系统原理和风险的基础上使用
5. **遵守法规**：用户应遵守所在国家/地区的法律法规，合法使用本系统

## 十一、技术支持与更新

### 11.1 获取支持

1. **GitHub Issues**：通过项目GitHub仓库的Issues页面提交问题
2. **文档查阅**：仔细阅读README.md和本策略文档
3. **代码审查**：对于技术问题，建议先审查相关源代码
4. **社区讨论**：可在相关技术社区讨论交流

### 11.2 版本更新

1. **定期更新**：项目会定期更新优化，建议关注GitHub仓库
2. **更新日志**：每次更新都会有详细的更新日志说明
3. **兼容性**：注意版本更新可能涉及配置变更，需相应调整
4. **备份数据**：更新前务必备份重要数据和配置

### 11.3 贡献指南

欢迎对项目进行改进和优化：

1. **代码贡献**：提交Pull Request，遵循项目代码规范
2. **文档改进**：完善文档，提高可读性和实用性
3. **问题反馈**：报告Bug或提出改进建议
4. **测试验证**：帮助进行回测验证和实盘测试

## 十二、总结

币安自动做T交易系统是一个功能完整、风险可控的自动化交易解决方案。系统基于振幅交易策略，通过多层保护机制确保交易安全，适合有一定技术基础的用户使用。

### 12.1 核心价值

1. **自动化交易**：解放人力，实现24小时不间断交易
2. **风险可控**：多层保护机制，有效控制交易风险
3. **策略透明**：策略逻辑清晰，参数可调可优化
4. **易于扩展**：模块化设计，便于功能扩展和策略改进

### 12.2 使用建议

1. **充分学习**：在使用前充分理解系统原理和策略逻辑
2. **谨慎配置**：根据自身风险承受能力合理配置参数
3. **持续优化**：根据市场变化和交易表现持续优化参数
4. **风险第一**：始终将风险控制放在首位，避免过度交易

### 12.3 未来展望

随着技术的不断发展和市场的不断变化，系统将持续优化和改进：

1. **策略多样化**：支持更多交易策略和指标
2. **智能化提升**：引入更多AI和机器学习技术
3. **生态扩展**：支持更多交易所和交易品种
4. **用户体验**：持续优化界面和操作体验

---

**最后提醒**：交易有风险，投资需谨慎。请在使用本系统前充分了解相关风险，并根据自身情况合理配置和使用。

**祝您交易顺利！**

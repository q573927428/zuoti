# 项目交易流程和策略

### 1. 交易状态机
项目采用5个状态的状态机：
- **IDLE**：空闲状态，寻找交易机会
- **BUY_ORDER_PLACED**：买单已挂，等待成交
- **BOUGHT**：已买入，准备挂卖单
- **SELL_ORDER_PLACED**：卖单已挂，等待成交
- **DONE**：交易完成，返回IDLE

### 2. 完整交易流程
1. **机会发现**：分析所有交易对（ETH/USDT, BTC/USDT, BNB/USDT, SOL/USDT）的15分钟K线
2. **振幅筛选**：计算6小时（24根15分钟K线）的振幅，筛选振幅≥阈值（默认3%）的交易对
3. **趋势过滤**：排除单边趋势超过阈值（默认5%）的交易对
4. **价格计算**：在振幅区间内计算买入价和卖出价（使用priceRangeRatio参数，默认0.11）
5. **挂买单**：创建限价买单，设置保护机制
6. **等待成交**：监控买单状态，检查保护机制和超时
7. **挂卖单**：买单成交后，重新分析市场计算卖出价，挂限价卖单
8. **等待卖出**：监控卖单状态，检查止损和保护机制
9. **完成交易**：卖单成交后计算收益，更新统计

### 3. 完整交易策略

#### 核心策略参数：
- **投资金额**：每次交易固定金额（默认1500 USDT）
- **振幅阈值**：筛选交易对的最小振幅（默认3%）
- **趋势阈值**：过滤单边趋势的阈值（默认5%）
- **价格区间比例**：买入/卖出价距离边界的比例（默认0.11）
- **交易对**：ETH/USDT, BTC/USDT, BNB/USDT, SOL/USDT

#### 交易逻辑：
1. **多交易对轮询**：同时监控多个交易对，选择振幅最大的
2. **日内交易**：每个交易日独立，不持仓过夜
3. **限价单交易**：使用限价单而非市价单，控制成本
4. **区间交易**：在振幅区间内低买高卖

### 4. 交易保护措施

#### 多层保护机制：

**1. 熔断机制（Circuit Breaker）**
- 连续失败次数限制：5次
- 单日亏损限额：20 USDT
- 总亏损限额：100 USDT
- 价格波动阈值：10%
- 冷却时间：12小时

**2. 止损机制（Stop Loss）**
- 硬止损阈值：-2%
- 执行价格折扣：0.998
- 等待确认时间：5秒

**3. 保护机制（Protection）**
- 突破保护：价格突破上界时取消买单
- 跌破保护：价格跌破下界时取消买单
- 市场反转保护：价格跌破原区间下界时取消卖单
- 价格偏离保护：卖单价格偏离当前价>2%时取消

**4. 超时机制**
- 买单超时：1小时
- 卖单超时：2小时
- 默认超时：2小时

**5. 日切机制**
- 日切处理时间：23:00
- 日切预警时间：22:30
- 强制平仓折扣：0.999
- 跨日强制平仓

**6. 交易限制**
- 每日交易次数限制：3次
- 交易间隔：1小时
- 余额安全缓冲：5%
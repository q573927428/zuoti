# 币安2年历史数据回测系统

基于现有交易项目的完整回测系统，支持多交易对、多参数扫描和详细分析报告。

## 项目概述

本回测系统基于以下项目逻辑构建：
- **交易策略**：振幅区间交易，低买高卖
- **交易对**：ETH/USDT, BTC/USDT, BNB/USDT, SOL/USDT
- **时间框架**：15分钟K线
- **回测年限**：2年历史数据
- **保护机制**：完整模拟项目的所有保护措施

## 核心参数

### 回测参数扫描范围
```javascript
// 振幅阈值列表 (R_LIST)
const R_LIST = [0.02, 0.025, 0.03, 0.035, 0.04]      // 2% - 4%

// 价格区间比例列表 (SHRINK_LIST)
const SHRINK_LIST = [0.08, 0.10, 0.12, 0.14, 0.15]   // 8% - 15%
```

### 策略参数（基于项目配置）
- **投资金额**：1500 USDT/次
- **手续费**：0.2% 双边
- **趋势过滤阈值**：5%
- **每日交易次数限制**：3次
- **交易间隔**：1小时

### 保护机制参数
- **突破保护**：BREAK_UP = 1.002
- **跌破保护**：BREAK_DOWN = 0.998

## 安装与运行

### 1. 安装依赖
```bash
cd backtest
npm install
```

### 2. 运行回测
```bash
npm start
```

### 3. 数据缓存
- K线数据会自动缓存到 `./backtest/data/` 目录
- 首次运行会从币安API拉取2年历史数据（需要网络连接）
- 后续运行会使用缓存数据，加快回测速度

## 回测输出

系统会生成详细的回测报告，包括：

### 1. 排名报告
- **按总收益排名**：前10名最佳参数组合
- **按收益率排名**：前10名最高收益率组合
- **按胜率排名**：交易次数>10的前10名高胜率组合

### 2. 交易对汇总
每个交易对的最佳参数和表现

### 3. 参数优化建议
基于前20名最佳表现，提供参数范围建议

### 4. 风险分析
- 盈利参数组合比例
- 平均收益、最大收益、最小收益
- 收益标准差（风险指标）

### 5. 详细数据
所有回测结果会保存到JSON文件，便于进一步分析

## 参数优化建议

基于项目分析和回测设计，以下是初步的参数优化建议：

### 1. 振幅阈值 (R)
- **当前项目默认**：1% (0.01)
- **回测扫描范围**：2%-4% (0.02-0.04)
- **建议范围**：2.5%-3.5%
- **理由**：较高的振幅阈值可以过滤掉波动性不足的交易机会，提高单次交易收益

### 2. 价格区间比例 (shrink)
- **当前项目默认**：12% (0.12)
- **回测扫描范围**：8%-15% (0.08-0.15)
- **建议范围**：10%-14%
- **理由**：适中的价格区间比例可以在保护机制和收益之间取得平衡

### 3. 趋势过滤阈值
- **当前项目默认**：5%
- **建议保持**：5%
- **理由**：有效过滤单边趋势，避免逆势交易

### 4. 保护机制参数
- **突破保护**：保持1.002 (0.2%)
- **跌破保护**：保持0.998 (0.2%)
- **理由**：适中的保护阈值可以在市场突变时及时退出

### 5. 交易限制
- **每日交易次数**：建议保持3次
- **交易间隔**：建议保持1小时
- **理由**：控制交易频率，避免过度交易

## 风险控制建议

### 1. 熔断机制
基于项目配置，建议：
- **连续失败次数**：5次（保持）
- **单日亏损限额**：20 USDT（根据投资金额调整）
- **总亏损限额**：100 USDT（根据投资金额调整）

### 2. 止损机制
- **硬止损阈值**：-2%（保持）
- **执行价格折扣**：0.998（保持）

### 3. 资金管理
- **单次投资比例**：建议不超过总资金的5%
- **最大持仓比例**：建议不超过总资金的20%
- **分散投资**：在多个交易对之间分散风险

## 实际部署建议

### 1. 参数配置
```javascript
// 推荐配置（基于回测分析）
const RECOMMENDED_CONFIG = {
  amplitudeThreshold: 0.03,      // 3% 振幅阈值
  priceRangeRatio: 0.12,         // 12% 价格区间比例
  trendThreshold: 5.0,           // 5% 趋势过滤
  investmentAmount: 20,          // 20 USDT/次（项目默认）
  dailyTradeLimit: 3,            // 每日3次交易
  tradeInterval: 3600000         // 1小时交易间隔
}
```

### 2. 监控指标
- **胜率**：目标 > 60%
- **平均收益率**：目标 > 0.5%/交易
- **最大回撤**：控制 < 10%
- **夏普比率**：目标 > 1.5

### 3. 定期优化
- **每月**：回顾交易表现，调整参数
- **每季度**：重新进行历史回测，优化参数
- **每年**：全面评估策略有效性

## 文件结构

```
backtest/
├── binance_2year_backtest.js    # 主回测脚本
├── package.json                 # 依赖配置
├── README.md                    # 说明文档
└── data/                        # 数据缓存目录
    ├── ETH_USDT_klines_cache.json
    ├── BTC_USDT_klines_cache.json
    ├── BNB_USDT_klines_cache.json
    ├── SOL_USDT_klines_cache.json
    └── backtest_results_*.json  # 回测结果文件
```

## 注意事项

1. **数据延迟**：币安API可能有数据延迟，回测使用历史数据
2. **网络要求**：首次运行需要稳定的网络连接获取历史数据
3. **计算资源**：全参数扫描需要一定的计算资源，建议在性能较好的机器上运行
4. **市场变化**：历史表现不代表未来收益，实际交易需谨慎
5. **手续费影响**：回测已考虑0.2%双边手续费，实际交易需注意交易所具体费率

## 技术支持

如需进一步优化或定制，请参考：
- 项目源代码：`server/utils/strategy.ts`
- 交易逻辑：`server/modules/trading-bot/StateHandlers.ts`
- 保护机制：`server/modules/trading-bot/CircuitBreakerManager.ts`
